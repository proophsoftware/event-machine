
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Functional Flavour</title>
<link rel="shortcut icon" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/prooph-logo@0.5x.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-57-precomposed.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@prooph_software">
<meta name="twitter:title" content="Event Machine">
<meta name="twitter:description" content="Rapid CQRS / ES framework for PHP with a path to refactor towards a richer domain model as needed.">
<meta name="twitter:image" content="https://proophsoftware.github.io/event-machine/img/Event_Machine_Intro.png">
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/lumen/bootstrap.min.css">
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-ghcolors.css"/>
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>
<style>
    body, html {
        height: 100%;
        padding-top: 36px;
        position: relative;
    }

    img {
        max-width: 100%;
    }

    code span {
        white-space: nowrap;
    }
    code span.comment {
        white-space: pre;
    }

    .highlight {
        background: #FFFF88;
    }

    .page-wrapper {
        min-height: 100%;
        padding-bottom: 170px;
        position: relative;
    }

    .box-header {
        position: relative;
    }

    /* Header Section */
    header {
        background: white;
        color: black;
        font-size: 16px;
        font-weight: 300;
    }

    h1:first-child {
        margin-top: 0;
    }

    /* anchor link will be displayed after the static top nav */
    h1:before,
    h2:before,
    h3:before,
    h4:before,
    h5:before,
    h6:before {
        display: block;
        content: " ";
        margin-top: -64px;
        height: 64px;
        visibility: hidden;
    }

    .navbar-brand {
        padding: 0;
    }

    .navbar-brand img {
        max-height: 100%;
    }

    /* Content Section */
    #content {
        margin-bottom: 17px;
        font-size: 17px;
        min-height: 200px;
    }

    .breadcrumb {
        position: relative;
        z-index: 999;
    }

    .links {
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        padding: 16px 0;
    }

    .links .prev {
        text-align: left;
    }

    .links .parent {
        text-align: center;
    }

    .links .next {
        text-align: right;
    }

    /* Search */
    .form-search {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
    }

    @media (max-width: 767px) {
        .form-search {
            position: relative;
            margin-top: 0;
        }
    }

    .form-search .form-control {
        border: 0;
        width: 80px;
    }

    @media (max-width: 767px) {
        .form-search .form-control {
            width: 100% !important;
        }
    }

    .form-search .list-search-results {
        position: relative;
    }

    .form-search .list-search-results ul {
        background: #eee;
        border: 1px solid inherit;
        list-style: none;
        max-height: 300px;
        overflow: auto;
        padding: 0;
        position: absolute;
        width: 100%;
        z-index: 999;
    }

    .form-search .list-search-results ul li:nth-child(even) {
        background: rgba(255, 255, 255, 0.3)
    }

    .form-search .list-search-results ul li.selected {
        background: #ccc;
    }

    .form-search .list-search-results ul li a {
        display: block;
        padding: 4px 8px;
    }

    /* TOC */
    .list-toc {
        padding: 0;
    }

    .list-toc .list-group-item {
        background: 0 none;
        position: relative;
        font-weight: bold;
        padding: 0;
        margin: 0;
    }

    .list-toc li .text-number {
        padding-left: 20px;
    }
    .list-toc li li .text-number {
        padding-left: 40px;
    }
    .list-toc li li li .text-number {
        padding-left: 60px;
    }
    .list-toc li li li li .text-number {
        padding-left: 80px;
    }
    .list-toc li li li li li .text-number {
        padding-left: 100px;
    }
    .list-toc .text-number {
        padding-left: 100px;
    }

    .list-toc .list-group-item .row {
        padding: 7px 0 7px;
    }

    .list-toc .list-group-item .bbt-toc-toggle {
        display: block;
        position: absolute;
        top: 5px;
        right: 10px;
        font-weight: normal;
    }

    .list-toc .list-group-item .bbt-toc-toggle:before {
        content: "";
        display: block;
    }

    .list-toc .list-group-item .bbt-toc-toggle.collapsed:before {
        content: "";
        display: block;
    }

    .list-toc > li:nth-child(2n+1) {
        background: rgba(0, 0, 0, 0.03);
    }

    .bbt-theme-cyborg .list-toc > li:nth-child(2n+1),
    .bbt-theme-darkly .list-toc > li:nth-child(2n+1),
    .bbt-theme-slate .list-toc > li:nth-child(2n+1),
    .bbt-theme-superhero .list-toc > li:nth-child(2n+1) {
        background: rgba(255, 255, 255, 0.05);
    }

    .list-toc .list-group-item {
        border-bottom: 0 none;
        border-left: 0 none;
        border-right: 0 none;
        font-size: inherit;
    }

    .list-toc .list-group-item:first-child {
        border-top-right-radius: 0;
        border-top-left-radius: 0;
    }

    .list-toc .list-group-item:last-child {
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* Left navigation */
    .nav-left ul li a {
        padding-top: 3px;
        padding-bottom: 3px;
        border-left: 1px solid transparent;
    }

    .nav-left ul li.active a,
    .nav-left ul li a:hover {
        background: none !important;
        color: inherit;
        border-color: inherit;
    }

    .navbar-top {
        position: relative;
    }

    .affix {
        top: 60px;
    }

    .badge {
        border-radius: 4px;
        padding: 5px;
    }

    /* Footer Section */
    footer {
        color: black;
        background: white;
        width: 100%;
        position: absolute;
        bottom: 0;
    }

    footer #copyright {
        padding: 30px;
        text-align: center;
        color: #444;
    }

    footer #copyright p {
        margin: 0;
    }

    footer #copyright span a {
        color: white;
    }

    /* Top Navigation */
    @media (max-width: 767px) {
        ul.navbar-nav {
            margin: 0 -15px
        }

        ul.navbar-nav li {
            border-radius: 0;
        }

        ul.navbar-nav li ul {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0;
            box-shadow: none;
            display: block;
            float: none;
            left: auto;
            padding: 0;
            position: static;
        }

        ul.navbar-nav li ul li a {
            padding: 8px 30px;
        }

        ul.navbar-nav li ul li ul li a {
            padding: 6px 40px;
        }
    }

    @media (min-width: 768px) {

        ul.navbar-nav li {
            display: block;
            position: relative;
            float: left;
        }

        ul.navbar-nav li ul {
            display: none;
        }

        ul.navbar-nav li a {
            display: block;
        }

        ul.navbar-nav li:hover > ul {
            display: block;
            position: absolute;
        }

        ul.navbar-nav li:hover li {
            float: none;
        }

        ul.navbar-nav ul ul {
            left: 100%;
            top: 0;
        }
    }
</style>
    <style>
    body {
        font-size: 16px;
    }
    /* Header Section */
    header {
        font-size: 17px;
        font-weight: 400;
    }

    .dropdown-menu {
        font-size: 17px;
    }

    .alert-light {
        color: #818182;
        background-color: #fefefe;
    }

    .alert-dark {
        color: #1b1e21;
        background-color: #d6d8d9;
        border-color: #c6c8ca;
    }

    .prooph-logo {
        float: left;
        margin-left: 8px;
        margin-right: 8px;
        transition-timing-function: ease-in-out;
        transition: all 5s;
        height: 50px;
        padding: 5px;
    }

    .jumbotron {
       background-color: #04A1B0;
    }

    .jumbotron .display-1 {
        color: white;
    }

    .jumbotron .display-2 {
        color: white;
    }

    .jumbotron pre {
        display: block;
        color: #f8f8f2;
        font-size: 13px;
        margin-top: 60px;
        border-radius: 0;
        border: none;
        background: #272822;
        padding: 1em;
        padding-bottom: 0px;
        overflow: auto;
        text-shadow: 0 1px rgba(0,0,0,0.3);
        font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        line-height: 1.5;
        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;
        -webkit-hyphens: none;
        -moz-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
    }

    .jumbotron pre.line-numbers {
        position: relative;
        padding-left: 3.8em;
        counter-reset: linenumber;
    }

    .jumbotron pre code {
        color: white;
        margin-left: -80px;
    }


    h2.front {
        text-align: center;
        font-size: 56px;
        margin-top: 100px;
        padding: 20px;
    }

    .intro {
        margin-top: 30px;
        font-size: 24px;
        font-weight: 200;
    }

    .intro.sub-intro {
        margin-top: 15px;
        margin-bottom: 15px;
    }

    .flavour {
        height: 200px;
    }

    .flavour h3 {
        color: white;
        font-size: 30px;
    }

    .flavour h3 small {
        color: #f2f2f2;
        font-size: 20px;
    }

    .flavour.prototyping {
        background-color: #CC3340;
    }

    .flavour.functional {
        background-color: #EB6842;
    }

    .flavour.oop {
        background-color: #715671;
    }

    .flavour.mixed {
        background-color: #26896C;
    }

    .btn-get-started {
        background-color: #04A1B0;
        color: white;
        padding: 20px 26px;
        font-size: 35px;
        border-radius: 8px;
        width: 100%;
        -webkit-transition-duration: 0.4s; /* Safari */
        transition-duration: 0.4s;
    }

    .btn-get-started:hover {
        background-color: #04c8d7;
        color: white;
        border-bottom-width: 4px;
        margin-top: 0px;
    }

    .img-center {
        display: block;
        margin-left: auto;
        margin-right: auto;
        width: 50%;
    }


    #forkongithub a {
        background: #000;
        color: #fff;
        text-decoration: none;
        font-family: arial, sans-serif;
        text-align: center;
        font-weight: bold;
        padding: 5px 40px;
        font-size: 1rem;
        line-height: 2rem;
        position: relative;
        transition: 0.5s;
    }

    #forkongithub a:hover {
        background: #c11;
        color: #fff;
    }

    #forkongithub a::before, #forkongithub a::after {
        content: "";
        width: 100%;
        display: block;
        position: absolute;
        top: 1px;
        left: 0;
        height: 1px;
        background: #fff;
    }

    #forkongithub a::after {
        bottom: 1px;
        top: auto;
    }

    @media screen and (min-width: 800px) {
        #forkongithub {
            position: fixed;
            display: block;
            top: 0;
            right: 0;
            width: 200px;
            overflow: hidden;
            height: 200px;
            z-index: 1000;
        }

        #forkongithub a {
            width: 200px;
            position: absolute;
            top: 80px;
            right: -60px;
            transform: rotate(45deg);
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            -moz-transform: rotate(45deg);
            -o-transform: rotate(45deg);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.8);
        }
    }

    @media screen and (max-width: 799px) {
        .jumbotron {
            margin-top: 60px;
        }
    }

    @media screen and (max-width: 991px) {
        .jumbotron pre {
            display: none;
        }

        .flavour {
            margin-top: 60px;
        }
    }
</style>
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-lumen">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="https://proophsoftware.github.io/event-machine/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://proophsoftware.github.io/event-machine/">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                    <defs>
                        <style>
                            .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                        </style>
                    </defs>
                    <title>prooph-logo</title>
                    <g id="artwork">
                        <g id="Layer_5" data-name="Layer 5">
                            <path class="cls-1"
                                  d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                            <path class="cls-2"
                                  d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                            <path class="cls-3"
                                  d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                            <path class="cls-4"
                                  d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                            <path class="cls-5"
                                  d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                            <path class="cls-6"
                                  d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                        </g>
                    </g>
                </svg>
            </a>

        </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/intro/">Introduction</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/intro/about.html">About Event Machine</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/intro/pros_and_cons.html">Pros and cons</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/">Tutorial</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/intro.html">Introduction</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/partI.html">Part I - Add A Building</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/partII.html">Part II - The Building Aggregate</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/partIII.html">Part III - Aggregate State</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/partIV.html">Part IV - Projections and Queries</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/partV.html">Part V - DRY</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/partVI.html">Part VI - Check in User</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/partVII.html">Part VII - The Unhappy Path</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/bonusI.html">Bonus I - Custom Projection</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/bonusII.html">Bonus II - Unit and Integration Tests</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/bonusIII.html">Bonus III - Functional Flavour</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/tutorial/bonusIV.html">Bonus IV - OOP Flavour</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/">API</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/set_up/">Set Up</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/set_up/installation.html">Installation</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/set_up/di.html">Dependency Injection</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/set_up/production_optimization.html">Optimize For Production</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/descriptions.html">Event Machine Descriptions</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/functional_flavour.html">Functional Flavour</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/immutable_state.html">Immutable State</a>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/document_store/">Document Store</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/document_store/set_up.html">Document Store</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/projections/">Projections</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/api/projections/set_up.html">Custom Projections</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/news/">News</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="https://proophsoftware.github.io/event-machine/news/2018-09-08-future.html">Future of Event Machine</a>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="https://proophsoftware.github.io/event-machine/">Event Machine Docs</a></li>
                                <li><a href="https://proophsoftware.github.io/event-machine/api/">API</a></li>
                                <li class="active">Functional Flavour</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#3-3" title="Functional&#x20;Flavour">Functional Flavour</a>
            </li>
                                <li>
                <a href="#3-3-1" title="Functions&#x20;vs.&#x20;Objects">Functions vs. Objects</a>
            </li>
                                <li>
                <a href="#3-3-2" title="1.&#x20;Pure&#x20;Functions">1. Pure Functions</a>
            </li>
                                                        <li>
                <a href="#3-3-3" title="2.&#x20;Stateless&#x20;Functions">2. Stateless Functions</a>
            </li>
                                                                                <li>
                <a href="#3-3-4" title="3.&#x20;Side-Effect&#x20;Free&#x20;Functions">3. Side-Effect Free Func...</a>
            </li>
                                <li>
                <a href="#3-3-5" title="Read&#x20;I&#x2F;O">Read I/O</a>
            </li>
                                <li>
                <a href="#3-3-6" title="Write&#x20;I&#x2F;O">Write I/O</a>
            </li>
                                <li>
                <a href="#3-3-7" title="Aggregate&#x20;Lifecycle">Aggregate Lifecycle</a>
            </li>
                                <li>
                <a href="#3-3-8" title="RecordThat">RecordThat</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="3-3">Functional Flavour</h1>
<blockquote>
<p>Event Sourced Aggregates are Domain-Driven Aggregates, representing a unit of consistency.
They protect invariants. This basically means that an aggregate makes sure that it can transition to a new state.
Different business rules can permit or prevent state transitions, and the aggregate has to enforce these business rules.</p>
</blockquote>
<p><em>Source: http://docs.getprooph.org/tutorial/event_sourcing_basics.html#1-3-3</em></p>
<h2 id="3-3-1">Functions vs. Objects</h2>
<p>Event Machine supports three programming styles out-of-the-box: <strong>OopFlavour, PrototypingFlavour and FunctionalFlavour</strong>.</p>
<p>On this page we focus on the Prototyping and Functional Flavour. Both follow the same idea of a <strong>functional core</strong>.
vent Sourcing is heavily based on functional patterns:
<em>immutable events</em>, <em>append-only streams</em>, <em>left fold of past events to calculate current state</em>, ...</p>
<p class="alert alert-info">The difference between Prototyping and Functional is that the <strong>PrototypingFlavour</strong> uses generic Event Machine messages while the
<strong>FunctionalFlavour</strong> is 100% decoupled from Event Machine. Code examples shown here are based on the PrototypingFlavour.
If you're curious how you can switch to another Flavour, then check out the Event Machine tutorial. It covers all three
Flavours in detail.</p>
<p><strong>Event Machine grows with your application from prototype to MVP up to a rock solid production system</strong>.
And it is able to reduce boilerplate code to a bare minimum because of a few "simple" rules:</p>
<h2 id="3-3-2">1. Pure Functions</h2>
<p>Given the same input a pure function will <strong>always</strong> produce the same result.</p>
<p>Here is the simplest form of a pure aggregate function in Event Machine:</p>
<h3 id="3-3-2-1">prooph/micro style</h3>
<pre><code class="language-php">//some_business_process.php

declare(strict_types=1);

Namespace Acme\Model\SomeBusinessProcess;

use Prooph\EventMachine\Messaging\Message;
use Acme\Api\Event;

const startProcess = '\Acme\SomeBusinessProcess\startProcess';

function startProcess(Message $startProcess): \Generator {
    yield [Event::SOME_PROCESS_STARTED, $startProcess-&gt;payload()];
}

//More functions ....

</code></pre>
<h3 id="3-3-2-2">Static method style</h3>
<pre><code class="language-php">//SomeBusinessProcess.php

declare(strict_types=1);

Namespace Acme\Model;

use Prooph\EventMachine\Messaging\Message;
use Acme\Api\Event;

final class SomeBusinessProcess
{
    public static function startProcess(Message $startProcess): \Generator
    {
        yield [Event::SOME_PROCESS_STARTED, $startProcess-&gt;payload()];
    }

    //more methods ....
}

</code></pre>
<p>As you can see both approaches are very similar. The <em>prooph/micro</em> style looks more functional and underlines the intention of the code whereby the
<em>static method</em> approach plays nice together with a modern IDE and PHP's autoloader. We'll stick to the static method approach in the examples because this is
the recommended style when working with Event Machine. But <em>prooph/micro</em> style can be used, too!</p>
<p>Back to the <strong>pure</strong> nature of both approaches. No matter how often you call the function as long as the input message payload does not change, the yielded
event won't change, too.</p>
<p class="alert alert-info">This property makes testing the function a breeze. You don't need mocks. You don't need heavy fixture setup. Just create the appropriate message, call the function and
test against an expected event.</p>
<h2 id="3-3-3">2. Stateless Functions</h2>
<p>No object, no internal state and therefor a much simpler business logic implementation, which is easy to test, refactor and maintain!</p>
<p>But even if we use functions, we have to be careful to not fall into the trap of modifying state:</p>
<h3 class="alert alert-danger" id="3-3-3-1">Evil Global Variable</h3>
<p>One way to break the rule with a function is by modifying global state.</p>
<pre><code class="language-php">//SomeBusinessProcess.php

declare(strict_types=1);

Namespace Acme\Model;

use Prooph\EventMachine\Messaging\Message;
use Acme\Api\Event;

$evilState = new EvilState();

final class SomeBusinessProcess
{
    public static function startProcess(Message $startProcess): \Generator
    {
        global $evilState;

        $evilState-&gt;burnStatelessApproach();

        yield [Event::SOME_PROCESS_STARTED, $startProcess-&gt;payload()];
    }

    //more methods ....
}

</code></pre>
<p><strong>Never ever do this!</strong> Don't even think about it!</p>
<h3 class="alert alert-danger" id="3-3-3-2">Evil Static Property</h3>
<p>Another way to break our stateless function:</p>
<pre><code class="language-php">//SomeBusinessProcess.php

declare(strict_types=1);

Namespace Acme\Model;

use Prooph\EventMachine\Messaging\Message;
use Acme\Api\Event;

final class SomeBusinessProcess
{
    private static $evilState;

    public static function startProcess(Message $startProcess): \Generator
    {
        self::$evilState = new EvilState();

        yield [Event::SOME_PROCESS_STARTED, $startProcess-&gt;payload()];
    }

    public static funcion continueProcess(Message $continue): \Generator
    {
        yield [Event::SOME_PROCESS_CONTINUED, self::$evilState-&gt;toArray()];
    }

    //more methods ....
}

</code></pre>
<h3 class="alert alert-danger" id="3-3-3-3">Evil Static Local Variable</h3>
<p>That's also a very bad idea:</p>
<pre><code class="language-php">//SomeBusinessProcess.php

declare(strict_types=1);

Namespace Acme\Model;

use Prooph\EventMachine\Messaging\Message;
use Acme\Api\Event;

final class SomeBusinessProcess
{
    public static function startProcess(Message $startProcess): \Generator
    {
        yield [Event::SOME_PROCESS_STARTED, $startProcess-&gt;payload()];
    }

    public static funcion continueProcess(Message $continue): \Generator
    {
        static $evilCounter;

        if($evilCounter === null) {
            $evilCounter = 0;
        }

        yield [Event::SOME_PROCESS_CONTINUED, ['counter' =&gt; ++$evilCounter]];
    }

    //more methods ....
}

</code></pre>
<h3 class="alert alert-danger" id="3-3-3-4">Evil Mutable State Passed As Argument</h3>
<p>Mutable state passed as an argument is probably the easiest way to break the stateless rule. Let's look at an evil example first and then we'll see how we
can do better.</p>
<pre><code class="language-php">//SomeBusinessProcess.php

declare(strict_types=1);

Namespace Acme\Model;

use Prooph\EventMachine\Messaging\Message;
use Acme\Api\Event;

final class SomeBusinessProcess
{
    public static function startProcess(Message $startProcess): \Generator
    {
        yield [Event::SOME_PROCESS_STARTED, $startProcess-&gt;payload()];
    }

    public static funcion continueProcess(EvilMutableState $evilState, Message $continue): \Generator
    {
        $evilState-&gt;burnStatelessApproach();

        yield [Event::SOME_PROCESS_CONTINUED, ['state' =&gt; $evilState-&gt;toArray()]];
    }

    //more methods ....
}

</code></pre>
<p class="alert alert-success"><strong>Let's fight the evil!</strong></p>
<pre><code class="language-php">//SomeBusinessProcess.php

declare(strict_types=1);

Namespace Acme\Model;

use Prooph\EventMachine\Messaging\Message;
use Acme\Api\Event;
use Acme\Api\Payload;

final class SomeBusinessProcess
{
    public static function startProcess(Message $startProcess): \Generator
    {
        yield [Event::SOME_PROCESS_STARTED, $startProcess-&gt;payload()];
    }

    public static function whenProcessStarted(Message $processStarted): ImmutableState
    {
        return new ImmutableState();
    }

    public static funcion continueProcess(ImmutableState $state, Message $continue): \Generator
    {
        if($state-&gt;wantsToBurnStatelessApproach()) {
            yield [Event::STATE_MUTATION_BLOCKED, [Payload::ALTERNATIVE =&gt; $continue-&gt;get(Payload::ALTERNATIVE)]];
        }
    }

    public static function whenStateMutationBlocked(ImmutableState $currentState, Message $stateMutationBlocked): ImmutableState
    {
        return $currentState-&gt;withAlternativeMutation($stateMutationBlocked-&gt;get(Payload::ALTERNATIVE));
    }
}

</code></pre>
<p>Ok, we see two new functions here. Both start with <code>when</code> followed by an event name.</p>
<p class="alert alert-light">Note: The naming is only a recommendation.</p>
<p>Those when functions do not take commands as input and do not yield events, but instead take yielded events as input and <strong>return</strong> (note the difference to yield)
<code>ImmutableState</code>. The second when function even takes <code>ImmutableState</code> as an argument and returns it.</p>
<p>To be able to understand the alternative to mutable state we have to jump into the method <code>withAlternativeMutation</code>:</p>
<pre><code class="language-php">declare(strict_types=1);

Namespace Acme\Model;

final class ImmutableState
{
    private $alternative;

    public function alternative(): ?string
    {
        return $this-&gt;alternative;
    }

    public function withAlternativeMutation(string $alternative): self
    {
        $copy = clone $this;
        $copy-&gt;alternative = $alternative;
        return $copy;
    }
}

</code></pre>
<p>This is how state of an immutable value object is changed. Instead of modifying internal state directly, the value object copies itself and modfies the copy
instead.</p>
<p class="alert alert-light">It works because visibility of properties and methods is defined on class level and not on instance level.</p>
<p>Let's look at the effect with a unit test:</p>
<pre><code class="language-php">declare(strict_types=1);

Namespace AcmeTest\Model;

use Acme\Api\Event;
use Acme\Api\Payload;
use Acme\Model\SomeBusinessProcess;
use Acme\Model\ImmutableState;
use AcmeTest\BaseTestCase; //&lt;-- extends PHPUnit\Framework\TestCase + provides message factory
use Prooph\EventMachine\Messaging\Message;

final class SomeBusinessProcessTest extends BaseTestCase
{
    /**
     * @test
     */
     public function it_does_not_change_input_state()
     {
        $inputState = new ImmutableState();

        $this-&gt;assertNull($inputState-&gt;alternative());

        $event = $this-&gt;messageFactory()-&gt;createMessageFromArray(
            Event::STATE_MUTATION_BLOCKED,
            [
                'payload' =&gt; [
                    'alternative' =&gt; 'modify and return copy'
                ]
            ]
        );

        $outputState = SomeBusinessProcess::whenStateMutationBlocked(
            $inputState,
            $event
        );

        $this-&gt;assertNull($inputState-&gt;alternative());

        $this-&gt;assertSame(
            'modify and return copy',
            $outputState-&gt;alternative()
        );
     }
}

</code></pre>
<p class="alert alert-success">Working with <strong>immutable state</strong> avoids a whole bunch of silly and hidden errors. Function calls are predictable.
You can harden the system With simple tests, pave the way for refactorings and keep velocity high.
Event Machine also has an easy job. It does not need to care about state changes, because they are fully managed in userland code.
This means, that you have full control. <strong>No object mapping layer required, no dirty state and no unit of work.</strong></p>
<p class="alert alert-light">The "Immutable State" chapter provides a lot of tips and tricks to rapidly create and work with immutable value objects.</p>
<h2 id="3-3-4">3. Side-Effect Free Functions</h2>
<p>Modifying global state is one kind of side-effect, <code>I/O</code> is another. I/O is the short term for <code>Input/Output</code> and includes things like reading from or writing to a database,
accessing the filesystem or calling a remote service. It describes any operation that might fail due to unavailability of the target system.
If a function (or method) performs a database query but the database is down, the function will behave different than in normal cases. Hence, the result of the
function call is not predictable.</p>
<p class="alert alert-warning">Side-Effects make testing harder. Performing <strong>I/O</strong> usually requires mocking and you have to test against more scenarios.
That's a bad situation specifically for business logic tests. When testing business logic you should focus on its behaviour and only on that!
Mixing <strong>I/O</strong> into the game makes it difficult.</p>
<p>If we must not query a database or call a remote service in aggregate functions, where do we do it then?
Well, outside of the <strong>functional core</strong>. The following diagram illustrates that idea.</p>
<p><img src="https://proophsoftware.github.io/event-machine/api/img/event_machine_functional_core.png" alt="Event Machine + Functional Core"></p>
<p class="alert alert-light">The diagram shows three layers. The outermost layer is where <code>I/O</code> happens. Event Machine acts as a middleware between <code>I/O</code> layer and the <code>functional core</code>.</p>
<h2 id="3-3-5">Read I/O</h2>
<p>We can tell Event Machine to invoke a <code>ContextProvider</code> before invoking an aggregate function.
That's the preferred way to perform read I/O to query data needed by the aggregate.</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace Prooph\EventMachine\Aggregate;

use Prooph\EventMachine\Messaging\Message;

interface ContextProvider
{
    /**
     * @param Message $command
     * @return mixed The context passed as last argument to aggregate functions
     */
    public function provide(Message $command);
}

</code></pre>
<p class="alert alert-dark">Let's say we have a shopping cart aggregate that processes <strong>AddItem</strong> commands.
The command payload only contains the <strong>itemId</strong> but we also need the <strong>price</strong> of the item
to enable <strong>free shipping</strong> if a certain order sum is reached.</p>
<p class="alert alert-light">Context Provider: uses a price finder to get item price from a <strong>database</strong> and sets up a free shipping policy with 40,- € (4000 Cent) as minimum order sum.</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace ProophExample\ContextProvider;

use Prooph\EventMachine\Aggregate\ContextProvider;
use Prooph\EventMachine\Messaging\Message;
use ProophExample\ContextProvider\Api\Payload;
use ProophExample\ContextProvider\Policy\FreeShipping;
use ProophExample\ContextProvider\ShoppingCart\AddItemContext;

final class AddItemContextProvider implements ContextProvider
{
    /**
     * @var PriceFinder
     */
    private $priceFinder;

    /**
     * @param Message $command
     * @return mixed The context passed as last argument to aggregate functions
     */
    public function provide(Message $command)
    {
        $itemId = ItemId::fromString($command-&gt;get(Payload::ITEM_ID));
        $itemPrice = $this-&gt;priceFinder-&gt;findItemPrice($itemId);

        $item = Item::withIdAndPrice($itemId, $itemPrice);
        $freeShipping = FreeShipping::fromInt(4000);

        return AddItemContext::fromRecordData(['item' =&gt; $item, 'freeShipping' =&gt; $freeShipping]);
    }
}

</code></pre>
<p class="alert alert-light">Command Processing Description: <strong>AddItemContextProvider service id</strong> (FQCN) is passed to provideContext.</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace ProophExample\ContextProvider\Api;

use Prooph\EventMachine\EventMachine;
use Prooph\EventMachine\EventMachineDescription;
use ProophExample\ContextProvider\AddItemContextProvider;
use ProophExample\ContextProvider\ShoppingCart;

final class Aggregate implements EventMachineDescription
{
    const SHOPPING_CART = 'ShoppingCart';

    public static function describe(EventMachine $eventMachine): void
    {
        //...
        $eventMachine-&gt;process(Command::ADD_ITEM)
            -&gt;withExisting(self::SHOPPING_CART)
            -&gt;provideContext(AddItemContextProvider::class)
            -&gt;handle([ShoppingCart::class, 'addItem'])
            -&gt;recordThat(Event::ITEM_ADDED)
            -&gt;apply([ShoppingCart::class, 'whenItemAdded'])
            -&gt;andRecordThat(Event::FREE_SHIPPING_ENABLED)
            -&gt;apply([ShoppingCart::class, 'whenFreeShippingEnabled']);
    }
}

</code></pre>
<p class="alert alert-light">Shopping Cart Aggregate: receives <strong>AddItemContext</strong> as third argument in the <strong>addItem</strong> function</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace ProophExample\ContextProvider;

use Prooph\EventMachine\Messaging\Message;
use ProophExample\ContextProvider\Api\Event;
use ProophExample\ContextProvider\Api\Payload;
use ProophExample\ContextProvider\ShoppingCart\AddItemContext;
use ProophExample\ContextProvider\ShoppingCart\State;

final class ShoppingCart
{
    //...

    public static function addItem(State $cart, Message $addItem, AddItemContext $context): \Generator
    {
        yield [Event::ITEM_ADDED, [
            Payload::SHOPPING_CART_ID =&gt; $addItem-&gt;get(Payload::SHOPPING_CART_ID),
            Payload::ITEM =&gt; $context-&gt;item()-&gt;toArray(),
        ]];

        if(!$cart-&gt;freeShipping()) {
            //Temporarily add item. We can safely do this, because $cart is immutable
            $cart = $cart-&gt;withAddedItem($context-&gt;item());

            if($context-&gt;freeShipping()-&gt;isFree($cart-&gt;orderSum())) {
                yield [Event::FREE_SHIPPING_ENABLED, [
                    Payload::SHOPPING_CART_ID =&gt; $addItem-&gt;get(Payload::SHOPPING_CART_ID),
                ]];
            }
        }
    }

    public static function whenItemAdded(State $cart, Message $itemAdded): State
    {
        return $cart-&gt;withAddedItem(Item::fromArray($itemAdded-&gt;get(Payload::ITEM)));
    }

    public static function whenFreeShippingEnabled(State $cart, Message $freeShippingEnabled): State
    {
        return $cart-&gt;withFreeShippingEnabled();
    }
}

</code></pre>
<p class="alert alert-light"><em>Full example code can be found in the "examples/ContextProvider" dir of the event-machine-docs repository on Github.</em></p>
<h2 id="3-3-6">Write I/O</h2>
<p>Event Machine appends all yielded events to the <code>write model event stream</code>. You don't need to care about that.
Read model updates are performed by projections (see "Projections" chapter) and all other Write I/O should happen in event listeners (see "Event Listeners" chapter).</p>
<p class="alert alert-warning">Aggregate functions should NEVER perform any write operation directly but only yield events to trigger Write I/O in the outermost layer.</p>
<h2 id="3-3-7">Aggregate Lifecycle</h2>
<p class="alert alert-light">If an aggregate is composed of pure functions and those functions work with immutable state only, does the aggregate have a lifecycle?</p>
<p>Yes! An aggregate has a lifecycle. It is just not implemented as an object that changes internal state over time.
But an aggregate is still a domain concept - a business process.
Each aggregate has a <strong>unique id</strong> and yielded events should contain that id (otherwise Event Machine throws an exception)
so that the events can be added to the <strong>event stream</strong> of the aggregate.
An event stream can be seen as a timeline. It tracks all important facts about the aggregate.</p>
<p><img src="https://proophsoftware.github.io/event-machine/api/img/Aggregate_Stream.png" alt="Aggregate Stream"></p>
<p class="alert alert-light">But how can Event Machine always pass the current state of an aggregate to the next function?</p>
<p>It seems like aggregate state is magically passed to aggregate functions. But the mechanism used by Event Machine is relatively simple.
It is best explained with our shopping cart example again.</p>
<pre><code class="language-php">$eventMachine-&gt;process(Command::START_SHOPPING_SESSION)
    -&gt;withNew(self::SHOPPING_CART)
    -&gt;identifiedBy(Payload::SHOPPING_CART_ID)
</code></pre>
<p>Event Machine gets two important information here. The first one is that the lifecycle of our <code>ShoppingCart</code> aggregate
begins with a <code>StartShoppingSession</code> command. And the second is that a <code>ShoppingCart</code> is identified by its <code>ShoppingCartId</code>.
<strong>All</strong> commands addressing the shopping cart should contain the <code>ShoppingCartId</code> and <strong>all</strong> events yielded by the aggregate should contain the same
id.</p>
<pre><code class="language-php">$eventMachine-&gt;process(Command::START_SHOPPING_SESSION)
        -&gt;withNew(self::SHOPPING_CART)
        -&gt;identifiedBy(Payload::SHOPPING_CART_ID)
    -&gt;handle([ShoppingCart::class, 'startShoppingSession'])
</code></pre>
<p>Given the information above, Event Machine knows that the aggregae function <code>ShoppingCart::startShoppingSession()</code>
only takes a <code>StartShoppingSession</code> command as argument. Aggregate state doesn't exist at this time
because it's the first command.</p>
<pre><code class="language-php">&lt;?php

//...

final class ShoppingCart
{
    public static function startShoppingSession(Message $startShoppingSession): \Generator
    {
        yield [Event::SHOPPING_SESSION_STARTED, [
            Payload::SHOPPING_CART_ID =&gt; $startShoppingSession-&gt;get(Payload::SHOPPING_CART_ID),
        ]];
    }

    //...
}
</code></pre>
<p>Event Machine will append the yielded <code>ShoppingSessionStarted</code> event to its <code>write model event stream</code>. This event will mark the beginning
of a new shopping cart lifecycle.</p>
<p>Every yielded event should have a corresponding <strong>apply function</strong>. Event Machine takes care of that rule.
It's the last part of every <code>CommandProcessingDescription</code>.</p>
<pre><code class="language-php">$eventMachine-&gt;process(Command::START_SHOPPING_SESSION)
        -&gt;withNew(self::SHOPPING_CART)
        -&gt;identifiedBy(Payload::SHOPPING_CART_ID)
        -&gt;handle([ShoppingCart::class, 'startShoppingSession'])
    -&gt;recordThat(Event::SHOPPING_SESSION_STARTED)
    -&gt;apply([ShoppingCart::class, 'whenShoppingSessionStarted']);
</code></pre>
<p>A <code>recordThat</code> call should always be followed by an <code>apply</code> call. Obvousely, it's a mapping so that Event Machine knows which <code>apply</code> function to use.
And because the entire description is bound to the command being processed, Event Machine knows again that <code>ShoppingCart::whenShoppingSessionStarted</code> is the first
apply function and therefor does not take aggregate state as an argument. But the apply function should return the first <strong>immutable state</strong> derived from the first event.</p>
<pre><code class="language-php">&lt;?php

//...

final class ShoppingCart
{
    //...

    public static function whenShoppingSessionStarted(Message $shoppingSessionStarted): State
    {
        return State::newSession(ShoppingCartId::fromString(
            $shoppingSessionStarted-&gt;get(Payload::SHOPPING_CART_ID)
        ));
    }
}
</code></pre>
<p class="alert alert-info">All subsequent aggregate functions (command handling and event applying functions) receive the current aggregate state as the first argument.</p>
<p>The following diagram illustrates how Event Machine calculates current state with the help of the <code>apply</code> functions.</p>
<p><img src="https://proophsoftware.github.io/event-machine/api/img/Aggregate_Lifecycle.png" alt="Aggregate Lifecycle"></p>
<h2 id="3-3-8">RecordThat</h2>
<p>The <code>CommandProcessingDescription</code> defines two aliases for <code>recordThat</code>: <code>andRecordThat</code> and <code>orRecordThat</code>. You can use them when an aggregate function
yields multiple events (andRecordThat) or different events depending on conditions (orRecordThat).</p>
<p class="alert alert-warning">Event Machine doesn't really care about which variant you use, but if an aggregate function yields an unknown event (no recordThat-&gt;apply pair defined)
Event Machine will throw an exception.</p>
<pre><code class="language-php">$eventMachine-&gt;process(Command::ADD_ITEM)
        -&gt;withExisting(self::SHOPPING_CART)
        -&gt;provideContext(AddItemContextProvider::class)
        -&gt;handle([ShoppingCart::class, 'addItem'])
    -&gt;recordThat(Event::ITEM_ADDED)
        -&gt;apply([ShoppingCart::class, 'whenItemAdded'])
    -&gt;andRecordThat(Event::FREE_SHIPPING_ENABLED)
        -&gt;apply([ShoppingCart::class, 'whenFreeShippingEnabled']);
</code></pre>
<p>It's not required that all events are yielded each time. The main thing is that Event Machine knows about them all.
In some situations an aggregate function does not want to yield any new event. In such a case you can <code>yield null</code> and return from the function.</p>
<pre><code class="language-php">&lt;?php

//...

final class ShoppingCart
{
    //...

    public static function removeItem(State $cart, Message $removeItem): \Generator
    {
        $item = Item::fromArray($removeItem-&gt;get(Payload::ITEM));

        if(!$cart-&gt;hasItem($item)) {
            yield null;
            return;
        }

        yield [Event::ITEM_REMOVED, $removeItem-&gt;payload()];
    }
}
</code></pre>
<p class="alert alert-info"><strong>Wrap UP:</strong> Aggregates in Event Machine are composed of pure functions and immutable state (when using Prototyping or Functional Flavour). Command Processing Descriptions tell Event Machine how the pieces fit
together. This reduces boilerpate code and we can focus on the domain and avoid silly bugs that interrupt our model exploration.</p>
<p>In the next chapter you'll learn how immutable value objects can be generated quickly.</p>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="https://proophsoftware.github.io/event-machine/api/descriptions.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="https://proophsoftware.github.io/event-machine/api/immutable_state.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p><a href="http://prooph-software.de/about.html">Imprint</a> | Powered by <a href="https://github.com/tobiju/bookdown-bootswatch-templates" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<span id="forkongithub"><a href="https://github.com/proophsoftware/event-machine-docs">Fork me on GitHub</a></span><script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
<script src="https://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
</body></html>
